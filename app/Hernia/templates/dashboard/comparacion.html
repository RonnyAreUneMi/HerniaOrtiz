{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard de Modelos - HERN.IA{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-800 dark:to-purple-800 rounded-2xl shadow-xl dark:shadow-2xl p-6 text-white border border-transparent dark:border-slate-600/50">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-white/20 dark:bg-white/10 rounded-xl flex items-center justify-center backdrop-blur border border-white/20 dark:border-white/10">
                    <svg class="w-8 h-8 text-white drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold drop-shadow-sm">Dashboard de An√°lisis de Modelos</h1>
                    <p class="text-blue-100 dark:text-blue-200">Comparaci√≥n completa de rendimiento y m√©tricas</p>
                </div>
            </div>
           
            <div class="text-right">
                <div class="text-sm text-blue-100 dark:text-blue-200">Modelos Analizados</div>
                <div class="text-2xl font-bold drop-shadow-sm" id="modelCount">0</div>
            </div>
        </div>
    </div>
    <!-- Training Loss -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-slate-600/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-slate-100">Training Loss</h3>
            </div>
            <div id="trainToggles" class="flex items-center space-x-4"></div>
        </div>
        <div id="trainChart" class="h-96 w-full bg-gray-50/50 dark:bg-slate-700/20 rounded-lg p-2"></div>
    </div>
    <!-- Validation Loss -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-slate-600/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-slate-100">Validation Loss</h3>
            </div>
            <div id="valToggles" class="flex items-center space-x-4"></div>
        </div>
        <div id="valChart" class="h-96 w-full bg-gray-50/50 dark:bg-slate-700/20 rounded-lg p-2"></div>
    </div>
    <!-- Accuracy per Class Comparison -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-emerald-900/20 dark:to-green-900/20 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-emerald-700/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center border border-green-200 dark:border-green-700/50">
                    <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-emerald-100">Accuracy por Clase</h3>
            </div>
        </div>
        <div id="accuracyChart" class="h-96 w-full bg-gray-50/50 dark:bg-slate-700/20 rounded-lg p-2"></div>
    </div>
    <!-- Confusion Matrices -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-purple-900/20 dark:to-indigo-900/20 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-purple-700/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center border border-purple-200 dark:border-purple-700/50">
                    <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v6a1 1 0 00-1-1h-2z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-purple-100">Matrices de Confusi√≥n</h3>
            </div>
        </div>
        <div id="confusionMatricesContainer" class="grid gap-6"></div>
    </div>
    <!-- F1-Score Comparison -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-blue-900/20 dark:to-cyan-900/20 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-blue-700/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center space-x-3 mb-4">
            <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center border border-blue-200 dark:border-blue-700/50">
                <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-blue-100">F1-Score por Clase</h3>
        </div>
        <div id="f1ScoreChart" class="h-96 w-full bg-gray-50/50 dark:bg-slate-700/20 rounded-lg p-2"></div>
    </div>
    <!-- Training Time Comparison -->
    <div class="bg-white dark:bg-gradient-to-br dark:from-orange-900/20 dark:to-red-900/20 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-orange-700/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center border border-orange-200 dark:border-orange-700/50">
                    <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-orange-100">Tiempo de Entrenamiento</h3>
            </div>
        </div>
        <div id="trainingTimeChart" class="h-80 w-full bg-gray-50/50 dark:bg-slate-700/20 rounded-lg p-2"></div>
    </div>
    <!-- Summary Tables -->
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Training Summary -->
        <div class="bg-white dark:bg-gradient-to-br dark:from-blue-900/30 dark:to-indigo-900/30 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-blue-600/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center border border-blue-200 dark:border-blue-700/50">
                    <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-blue-100">Resumen de Entrenamiento</h3>
            </div>
            <div class="overflow-x-auto bg-gray-50/50 dark:bg-slate-700/20 rounded-lg">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-slate-600">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-l-lg">Modelo</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">√âpocas</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-r-lg">Mejor Loss</th>
                        </tr>
                    </thead>
                    <tbody id="trainingSummary" class="divide-y divide-gray-200 dark:divide-slate-600">
                        <tr><td colspan="3" class="text-center py-6 text-gray-500 dark:text-gray-400">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Performance Summary -->
        <div class="bg-white dark:bg-gradient-to-br dark:from-green-900/30 dark:to-emerald-900/30 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-green-600/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center border border-green-200 dark:border-green-700/50">
                    <svg class="w-4 h-4 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-green-100">Rendimiento</h3>
            </div>
            <div class="overflow-x-auto bg-gray-50/50 dark:bg-slate-700/20 rounded-lg">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-slate-600">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-l-lg">Modelo</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">Accuracy</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-r-lg">FPS</th>
                        </tr>
                    </thead>
                    <tbody id="performanceSummary" class="divide-y divide-gray-200 dark:divide-slate-600">
                        <tr><td colspan="3" class="text-center py-6 text-gray-500 dark:text-gray-400">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Class Performance -->
        <div class="bg-white dark:bg-gradient-to-br dark:from-purple-900/30 dark:to-pink-900/30 rounded-2xl shadow-sm dark:shadow-lg border border-gray-200 dark:border-purple-600/50 p-6 transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center border border-purple-200 dark:border-purple-700/50">
                    <svg class="w-4 h-4 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v6a1 1 0 00-1-1h-2z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-purple-100">Mejor por Clase</h3>
            </div>
            <div class="overflow-x-auto bg-gray-50/50 dark:bg-slate-700/20 rounded-lg">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-slate-600">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-l-lg">Clase</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700 dark:text-gray-300">Mejor Modelo</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700 dark:text-gray-300 rounded-r-lg">Accuracy</th>
                        </tr>
                    </thead>
                    <tbody id="classSummary" class="divide-y divide-gray-200 dark:divide-slate-600">
                        <tr><td colspan="3" class="text-center py-6 text-gray-500 dark:text-gray-400">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Winner Section -->
    <div id="winnerSection" class="hidden bg-gradient-to-r from-yellow-50 to-yellow-100 dark:from-yellow-900/20 dark:to-yellow-800/20 rounded-2xl border border-yellow-200 dark:border-yellow-700/50 p-6 shadow-sm dark:shadow-lg transition-all duration-300 hover:shadow-md dark:hover:shadow-xl">
        <div class="flex items-center space-x-4">
            <div class="w-16 h-16 bg-yellow-400 dark:bg-yellow-500 rounded-full flex items-center justify-center shadow-lg border border-yellow-300 dark:border-yellow-600">
                <svg class="w-8 h-8 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
            </div>
            <div>
                <h3 id="winnerTitle" class="text-xl font-bold text-yellow-800 dark:text-yellow-300"></h3>
                <p id="winnerDescription" class="text-yellow-700 dark:text-yellow-400"></p>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script src="{% static 'js/dashboard_charts.js' %}"></script>
<script src="{% static 'js/model_analytics.js' %}"></script>
<script>
let modelData = {};
const modelColors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'];
const modelColorMap = {
    'retinanet': '#3b82f6', // Azul
    'yolo': '#ef4444', // Rojo
    'resnet50': '#10b981', // Verde
    'efficientnet': '#f59e0b', // Amarillo
    'mobilenet': '#8b5cf6', // P√∫rpura
    'densenet': '#06b6d4' // Cian
};
const classNames = ['Hernia', 'L1', 'L2', 'L3', 'L4', 'L5', 'S1', 'Sin Hernia', 'T12'];
// Funci√≥n auxiliar para normalizar la estructura de datos
function normalizeModelData(data, modelKey) {
    const normalized = JSON.parse(JSON.stringify(data)); // Deep copy
   
    console.log(`Normalizando ${modelKey}:`, data);
   
    // Normalizar model_info
    if (!normalized.model_info) normalized.model_info = {};
    if (!normalized.model_info.architecture) {
        normalized.model_info.architecture = normalized.model_info.name ||
                                            normalized.model_info.model_name ||
                                            normalized.model_info.backbone ||
                                            modelKey.toUpperCase();
    }
   
    // Normalizar training_results para ResNet50 que usa training_history
    if (!normalized.training_results && normalized.training_history) {
        normalized.training_results = {
            train_loss_history: normalized.training_history.train_losses || [],
            val_loss_history: normalized.training_history.val_losses || [],
            best_val_loss: normalized.training_history.best_loss || Math.min(...(normalized.training_history.val_losses || [Infinity])),
            final_train_loss: normalized.training_history.train_loss_final ||
                             normalized.training_history.train_losses?.[normalized.training_history.train_losses.length - 1] || 0,
            final_val_loss: normalized.training_history.val_losses?.[normalized.training_history.val_losses.length - 1] || 0,
            best_epoch: normalized.training_history.best_epoch || 0
        };
    }
   
    // Asegurar que existan los arrays de loss
    if (!normalized.training_results.train_loss_history) {
        normalized.training_results.train_loss_history = normalized.training_results.train_losses || [];
    }
    if (!normalized.training_results.val_loss_history) {
        normalized.training_results.val_loss_history = normalized.training_results.val_losses || [];
    }
   
    // Normalizar training_config
    if (!normalized.training_config) normalized.training_config = {};
    if (!normalized.training_config.epochs_trained) {
        normalized.training_config.epochs_trained = normalized.training_history?.total_epochs ||
                                                   normalized.training_config.epochs_configured ||
                                                   normalized.training_results.train_loss_history.length ||
                                                   100;
    }
   
    // Normalizar performance_metrics desde evaluation_metrics (ResNet50)
    if (!normalized.performance_metrics && normalized.evaluation_metrics) {
        normalized.performance_metrics = {
            overall_accuracy: normalized.evaluation_metrics.overall_accuracy || 0,
            per_class_metrics: {},
            total_predictions: normalized.evaluation_metrics.total_predictions || 0,
            f1_macro: normalized.evaluation_metrics.f1_macro || 0,
            precision_macro: normalized.evaluation_metrics.precision_macro || 0,
            recall_macro: normalized.evaluation_metrics.recall_macro || 0
        };
    }
   
    // Si no existe performance_metrics, crear uno vac√≠o
    if (!normalized.performance_metrics) {
        normalized.performance_metrics = {
            overall_accuracy: 0,
            per_class_metrics: {},
            total_predictions: 0
        };
    }
   
    // Normalizar per_class_metrics desde per_class_metrics de ResNet50
    if (normalized.per_class_metrics && !Object.keys(normalized.performance_metrics.per_class_metrics).length) {
        normalized.performance_metrics.per_class_metrics = {};
        Object.keys(normalized.per_class_metrics).forEach(className => {
            const metrics = normalized.per_class_metrics[className];
            const classAccuracy = normalized.class_accuracies?.[className]?.accuracy || 0;
           
            normalized.performance_metrics.per_class_metrics[className] = {
                accuracy: classAccuracy,
                precision: (metrics.precision || 0) * 100, // Convertir a porcentaje
                recall: (metrics.recall || 0) * 100, // Convertir a porcentaje
                f1_score: (metrics.f1_score || metrics['f1-score'] || 0) * 100,
                support: normalized.class_accuracies?.[className]?.samples || 0,
                total_samples: normalized.class_accuracies?.[className]?.samples || 0,
                correct_predictions: metrics.tp || 0,
                tp: metrics.tp || 0,
                fp: metrics.fp || 0,
                fn: metrics.fn || 0
            };
        });
    }
   
    // Normalizar per_class_metrics desde class_metrics si existe (otros modelos)
    if (normalized.class_metrics && !Object.keys(normalized.performance_metrics.per_class_metrics).length) {
        normalized.performance_metrics.per_class_metrics = {};
        Object.keys(normalized.class_metrics).forEach(className => {
            const metrics = normalized.class_metrics[className];
            normalized.performance_metrics.per_class_metrics[className] = {
                accuracy: metrics.accuracy || metrics.precision || 0,
                precision: metrics.precision || 0,
                recall: metrics.recall || 0,
                f1_score: metrics.f1_score || metrics['f1-score'] || 0,
                support: metrics.support || 0,
                total_samples: metrics.support || 0,
                correct_predictions: Math.round((metrics.support || 0) * (metrics.accuracy || 0) / 100)
            };
        });
    }
   
    // Asegurar que overall_accuracy existe
    if (!normalized.performance_metrics.overall_accuracy && normalized.evaluation_metrics?.overall_accuracy) {
        normalized.performance_metrics.overall_accuracy = normalized.evaluation_metrics.overall_accuracy;
    }
   
    // Calcular overall_accuracy si no existe
    if (!normalized.performance_metrics.overall_accuracy && normalized.performance_metrics.per_class_metrics) {
        const classMetrics = Object.values(normalized.performance_metrics.per_class_metrics);
        if (classMetrics.length > 0) {
            const avgAccuracy = classMetrics.reduce((sum, m) => sum + (m.accuracy || 0), 0) / classMetrics.length;
            normalized.performance_metrics.overall_accuracy = avgAccuracy;
        }
    }
   
    // Normalizar speed_metrics desde evaluation_metrics (ResNet50)
    if (!normalized.speed_metrics) {
        if (normalized.evaluation_metrics) {
            normalized.speed_metrics = {
                fps: normalized.evaluation_metrics.fps || 30,
                training_time_minutes: normalized.training_time_minutes ||
                                      (normalized.training_config?.epochs_trained || 100) * 0.5,
                mean_inference_ms: normalized.evaluation_metrics.mean_inference_ms || 0
            };
        } else if (normalized.inference_speed) {
            normalized.speed_metrics = {
                fps: normalized.inference_speed.fps || 30,
                training_time_minutes: normalized.training_time_minutes ||
                                      (normalized.training_config?.epochs_trained || 100) * 0.5
            };
        } else {
            normalized.speed_metrics = {
                fps: 30,
                training_time_minutes: (normalized.training_config?.epochs_trained || 100) * 0.5
            };
        }
    }
   
// Normalizar confusion_matrix desde evaluation_results o directamente
    if (!normalized.confusion_matrix || Array.isArray(normalized.confusion_matrix)) {
        // ResNet50 tiene la matriz directamente como array en la ra√≠z del JSON
        if (Array.isArray(data.confusion_matrix)) {
            console.log(`${modelKey}: Usando confusion_matrix del array directo`);
            normalized.confusion_matrix = {
                matrix: data.confusion_matrix,
                classes: classNames
            };
        } else if (normalized.evaluation_results?.confusion_matrix) {
            console.log(`${modelKey}: Usando confusion_matrix de evaluation_results`);
            if (Array.isArray(normalized.evaluation_results.confusion_matrix)) {
                normalized.confusion_matrix = {
                    matrix: normalized.evaluation_results.confusion_matrix,
                    classes: classNames
                };
            } else {
                normalized.confusion_matrix = normalized.evaluation_results.confusion_matrix;
            }
        }
    }
   
    // Asegurar que la matriz tiene el formato correcto
    if (normalized.confusion_matrix && !normalized.confusion_matrix.matrix) {
        if (Array.isArray(normalized.confusion_matrix)) {
            normalized.confusion_matrix = {
                matrix: normalized.confusion_matrix,
                classes: classNames
            };
        }
    }
   
    console.log(`${modelKey} normalizado:`, normalized);
    return normalized;
}
async function loadModelData() {
    try {
        console.log('Iniciando carga de datos...');
        const djangoModelData = JSON.parse('{{ model_data_json|escapejs }}');
        console.log('Datos recibidos:', djangoModelData);
       
        if (!djangoModelData || typeof djangoModelData !== 'object') {
            console.error('Datos de modelo inv√°lidos:', djangoModelData);
            document.getElementById('modelCount').textContent = '0';
            return;
        }
       
        // Cargar y normalizar RetinaNet
        if (djangoModelData.retinanet) {
            modelData['retinanet'] = normalizeModelData(djangoModelData.retinanet, 'retinanet');
            console.log('RetinaNet cargado y normalizado');
        }
       
        // Cargar y normalizar YOLO
        if (djangoModelData.yolo) {
            modelData['yolo'] = normalizeModelData(djangoModelData.yolo, 'yolo');
            console.log('YOLO cargado y normalizado');
        }
       
        // Cargar y normalizar ResNet50
        if (djangoModelData.resnet50) {
            modelData['resnet50'] = normalizeModelData(djangoModelData.resnet50, 'resnet50');
            console.log('ResNet50 cargado y normalizado');
        }
       
        // Solo proceder si hay al menos un modelo
        if (Object.keys(modelData).length === 0) {
            console.warn('No model data available');
            document.getElementById('modelCount').textContent = '0';
            return;
        }
       
        console.log('Modelos cargados:', Object.keys(modelData));
        console.log('Datos normalizados:', modelData);
       
        // Actualizar contador de modelos
        document.getElementById('modelCount').textContent = Object.keys(modelData).length;
       
        // Configurar datos auxiliares
        if (typeof dashboardCharts !== 'undefined') {
            dashboardCharts.setModelData(modelData);
        }
        if (typeof modelAnalytics !== 'undefined') {
            modelAnalytics.setModelData(modelData);
        }
       
        createToggles();
        drawAllCharts();
        updateTables();
       
        // Solo ejecutar comparaciones si hay m√°s de un modelo
        if (Object.keys(modelData).length > 1) {
            determineWinner();
        }
       
    } catch (error) {
        console.error('Error loading model data:', error);
    }
}
function determineWinner() {
    if (Object.keys(modelData).length < 2) return;
   
    let bestModel = null;
    let bestScore = -1;
   
    Object.keys(modelData).forEach(key => {
        const data = modelData[key];
        // Score basado en precisi√≥n (70%) y velocidad (30%)
        const score = data.performance_metrics.overall_accuracy * 0.7 + (data.speed_metrics.fps / 50) * 30;
        if (score > bestScore) {
            bestScore = score;
            bestModel = data;
        }
    });
   
    if (bestModel) {
        document.getElementById('winnerSection').classList.remove('hidden');
        document.getElementById('winnerTitle').textContent = `üèÜ Modelo Ganador: ${bestModel.model_info.architecture}`;
        document.getElementById('winnerDescription').textContent = `Mejor balance entre precisi√≥n (${bestModel.performance_metrics.overall_accuracy.toFixed(1)}%) y velocidad (${bestModel.speed_metrics.fps.toFixed(1)} FPS)`;
    }
}
function createToggles() {
    createChartToggles('trainToggles', 'train');
    createChartToggles('valToggles', 'val');
}
function createChartToggles(containerId, chartType) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
   
    if (Object.keys(modelData).length === 0) {
        container.innerHTML = '<span class="text-sm text-red-500 dark:text-red-400">No hay modelos</span>';
        return;
    }
   
    Object.keys(modelData).forEach((key, index) => {
        const data = modelData[key];
        const toggle = document.createElement('div');
        toggle.className = 'flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700/50 transition-colors duration-200';
        toggle.innerHTML = `
            <input type="checkbox" id="${key}-${chartType}-toggle" class="model-toggle w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" checked>
            <div class="w-3 h-3 rounded-full border border-gray-300 dark:border-gray-600" style="background-color: ${modelColorMap[key] || modelColors[0]}"></div>
            <label for="${key}-${chartType}-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer select-none">
                ${data.model_info.architecture || data.model_info.name}
            </label>
        `;
        container.appendChild(toggle);
       
        toggle.querySelector('.model-toggle').addEventListener('change', () => {
            if (chartType === 'train') {
                drawApexChart('trainChart', 'train_loss_history', 'Training Loss', 'train');
            } else {
                drawApexChart('valChart', 'val_loss_history', 'Validation Loss', 'val');
            }
        });
    });
}
function drawAllCharts() {
    drawApexChart('trainChart', 'train_loss_history', 'Training Loss', 'train');
    drawApexChart('valChart', 'val_loss_history', 'Validation Loss', 'val');
    drawAccuracyChart();
    drawConfusionMatrices();
    drawF1ScoreChart();
    drawTrainingTimeChart();
}
function drawApexChart(containerId, lossType, title, chartType) {
    const activeModels = Object.keys(modelData).filter(key => {
        const toggle = document.getElementById(`${key}-${chartType}-toggle`);
        return toggle && toggle.checked;
    });
   
    if (activeModels.length === 0) {
        document.getElementById(containerId).innerHTML = '<div class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-slate-800/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600"><div class="text-center"><svg class="w-12 h-12 mx-auto mb-2 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg><p>No hay modelos seleccionados</p></div></div>';
        return;
    }
   
    const isDark = document.documentElement.classList.contains('dark');
    const maxEpochs = Math.max(...activeModels.map(key => modelData[key].training_results[lossType].length));
   
    const series = activeModels.map((key) => {
        const data = modelData[key];
        const history = data.training_results[lossType];
       
        return {
            name: `${data.model_info.architecture} (${history.length} √©pocas)`,
            data: history.map((loss, epoch) => ({
                x: epoch + 1,
                y: parseFloat(loss.toFixed(4))
            })),
            color: modelColorMap[key] || modelColors[0]
        };
    });
   
    const options = {
        series: series,
        chart: {
            type: 'line',
            height: 400,
            background: 'transparent',
            foreColor: isDark ? '#cbd5e1' : '#475569',
            fontFamily: 'Inter, system-ui, sans-serif',
            toolbar: {
                show: true,
                tools: {
                    download: true,
                    zoom: true,
                    zoomin: true,
                    zoomout: true,
                    pan: true,
                    reset: true
                },
                theme: isDark ? 'dark' : 'light',
                style: {
                    colors: isDark ? ['#cbd5e1'] : ['#475569']
                }
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800,
                animateGradually: {
                    enabled: true,
                    delay: 150
                },
                dynamicAnimation: {
                    enabled: true,
                    speed: 350
                }
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        markers: {
            size: 5,
            strokeWidth: 2,
            strokeColors: isDark ? '#1e293b' : '#ffffff',
            hover: {
                size: 8,
                sizeOffset: 3
            },
            discrete: []
        },
        grid: {
            show: true,
            borderColor: isDark ? '#374151' : '#f3f4f6',
            strokeDashArray: 0,
            position: 'back',
            xaxis: {
                lines: { show: false }
            },
            yaxis: {
                lines: { show: true }
            },
            padding: {
                top: 0,
                right: 0,
                bottom: 0,
                left: 0
            }
        },
        xaxis: {
            title: {
                text: '√âpocas',
                style: {
                    color: isDark ? '#cbd5e1' : '#475569',
                    fontSize: '14px',
                    fontWeight: 600
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b',
                    fontSize: '11px'
                },
                formatter: function(val) {
                    if (maxEpochs > 100) {
                        return val % 25 === 0 || val === 1 || val === maxEpochs ? val : '';
                    } else if (maxEpochs > 50) {
                        return val % 10 === 0 || val === 1 || val === maxEpochs ? val : '';
                    } else if (maxEpochs > 25) {
                        return val % 5 === 0 || val === 1 || val === maxEpochs ? val : '';
                    }
                    return val;
                }
            },
            axisBorder: {
                show: true,
                color: isDark ? '#64748b' : '#d1d5db'
            }
        },
        yaxis: {
            title: {
                text: 'Loss',
                style: {
                    color: isDark ? '#cbd5e1' : '#475569',
                    fontSize: '14px',
                    fontWeight: 600
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b',
                    fontSize: '11px'
                },
                formatter: function(val) {
                    return val.toFixed(3);
                }
            },
            axisBorder: {
                show: true,
                color: isDark ? '#64748b' : '#d1d5db'
            }
        },
        legend: {
            position: 'top',
            horizontalAlign: 'left',
            fontSize: '12px',
            fontWeight: 500,
            labels: {
                colors: isDark ? '#cbd5e1' : '#475569'
            }
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            style: {
                fontSize: '12px',
                fontFamily: 'Inter, system-ui, sans-serif'
            },
            x: {
                formatter: function(val) {
                    return '√âpoca ' + val;
                }
            },
            y: {
                formatter: function(val) {
                    return 'Loss: ' + val.toFixed(4);
                }
            },
            marker: {
                show: true
            },
            custom: function({series, seriesIndex, dataPointIndex, w}) {
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#1e293b' : '#ffffff';
                const textColor = isDark ? '#e2e8f0' : '#374151';
                const borderColor = isDark ? '#475569' : '#d1d5db';
               
                return `<div class="px-3 py-2 rounded-lg shadow-lg border" style="background-color: ${bgColor}; color: ${textColor}; border-color: ${borderColor}; font-family: Inter, system-ui, sans-serif;">
                    <div class="font-semibold text-sm">√âpoca ${w.globals.labels[dataPointIndex]}</div>
                    <div class="text-xs mt-1">Loss: ${series[seriesIndex][dataPointIndex].toFixed(4)}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${w.globals.seriesNames[seriesIndex]}</div>
                </div>`;
            }
        }
    };
   
    document.getElementById(containerId).innerHTML = '';
    const chart = new ApexCharts(document.getElementById(containerId), options);
    chart.render();
}
function updateTables() {
    updateTrainingSummary();
    updatePerformanceSummary();
    updateClassSummary();
}
function updateTrainingSummary() {
    const tbody = document.getElementById('trainingSummary');
    tbody.innerHTML = '';
   
    if (Object.keys(modelData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500 dark:text-red-400">No hay datos</td></tr>';
        return;
    }
   
    Object.keys(modelData).forEach((key) => {
        const data = modelData[key];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-3 px-4">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${modelColorMap[key] || modelColors[0]}"></div>
                    <span class="font-medium text-gray-900 dark:text-white text-sm">${data.model_info.architecture || data.model_info.name}</span>
                </div>
            </td>
            <td class="text-center py-3 px-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">
                    ${data.training_config.epochs_trained || data.training_config.epochs_configured}
                </span>
            </td>
            <td class="text-right py-3 px-4 font-mono text-sm text-gray-600 dark:text-gray-400">${data.training_results.best_val_loss.toFixed(4)}</td>
        `;
        tbody.appendChild(row);
    });
}
function updatePerformanceSummary() {
    const tbody = document.getElementById('performanceSummary');
    tbody.innerHTML = '';
   
    if (Object.keys(modelData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500 dark:text-red-400">No hay datos</td></tr>';
        return;
    }
   
    Object.keys(modelData).forEach((key) => {
        const data = modelData[key];
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-3 px-4">
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 rounded-full" style="background-color: ${modelColorMap[key] || modelColors[0]}"></div>
                    <span class="font-medium text-gray-900 dark:text-white text-sm">${data.model_info.architecture || data.model_info.name}</span>
                </div>
            </td>
            <td class="text-center py-3 px-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">
                    ${data.performance_metrics.overall_accuracy.toFixed(1)}%
                </span>
            </td>
            <td class="text-right py-3 px-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300">
                    ${data.speed_metrics.fps.toFixed(1)} FPS
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function updateClassSummary() {
    const tbody = document.getElementById('classSummary');
    tbody.innerHTML = '';
   
    if (Object.keys(modelData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500 dark:text-red-400">No hay datos</td></tr>';
        return;
    }
   
    classNames.forEach(className => {
        let bestModel = null;
        let bestAccuracy = -1;
       
        Object.keys(modelData).forEach(key => {
            const data = modelData[key];
            const classMetrics = data.performance_metrics.per_class_metrics[className];
            if (classMetrics && classMetrics.accuracy > bestAccuracy) {
                bestAccuracy = classMetrics.accuracy;
                bestModel = data.model_info.architecture || data.model_info.name;
            }
        });
       
        if (bestModel) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700/70 dark:text-gray-300">
                        ${className}
                    </span>
                </td>
                <td class="text-center py-3 px-4 text-sm font-medium text-gray-900 dark:text-white">${bestModel}</td>
                <td class="text-right py-3 px-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bestAccuracy >= 80 ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : bestAccuracy >= 60 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300'}">
                        ${bestAccuracy.toFixed(1)}%
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        }
    });
}
function drawAccuracyChart() {
    const series = [];
    const categories = classNames;
   
    Object.keys(modelData).forEach(key => {
        const data = modelData[key];
        const accuracies = categories.map(className => {
            const classMetrics = data.performance_metrics.per_class_metrics[className];
            return classMetrics ? classMetrics.accuracy : 0;
        });
       
        series.push({
            name: data.model_info.architecture || data.model_info.name,
            data: accuracies,
            color: modelColorMap[key] || modelColors[0]
        });
    });
   
    const isDark = document.documentElement.classList.contains('dark');
   
    const options = {
        series: series,
        chart: {
            type: 'bar',
            height: 400,
            background: 'transparent',
            foreColor: isDark ? '#cbd5e1' : '#475569',
            fontFamily: 'Inter, system-ui, sans-serif',
            toolbar: {
                show: true,
                theme: isDark ? 'dark' : 'light'
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '65%',
                endingShape: 'rounded',
                borderRadius: 4
            }
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            show: true,
            width: 1,
            colors: ['transparent']
        },
        xaxis: {
            categories: categories,
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b',
                    fontSize: '11px'
                }
            }
        },
        yaxis: {
            title: {
                text: 'Accuracy (%)',
                style: {
                    color: isDark ? '#cbd5e1' : '#475569'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b'
                }
            }
        },
        fill: {
            opacity: 0.9
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            style: {
                fontSize: '12px',
                fontFamily: 'Inter, system-ui, sans-serif'
            },
            y: {
                formatter: function (val) {
                    return val.toFixed(1) + '%';
                }
            },
            custom: function({series, seriesIndex, dataPointIndex, w}) {
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#1e293b' : '#ffffff';
                const textColor = isDark ? '#e2e8f0' : '#374151';
                const borderColor = isDark ? '#475569' : '#d1d5db';
               
                return `<div class="px-3 py-2 rounded-lg shadow-lg border" style="background-color: ${bgColor}; color: ${textColor}; border-color: ${borderColor}; font-family: Inter, system-ui, sans-serif;">
                    <div class="font-semibold text-sm">${w.globals.labels[dataPointIndex]}</div>
                    <div class="text-xs mt-1">Accuracy: ${series[seriesIndex][dataPointIndex].toFixed(1)}%</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${w.globals.seriesNames[seriesIndex]}</div>
                </div>`;
            }
        },
        legend: {
            labels: {
                colors: isDark ? '#cbd5e1' : '#475569'
            }
        },
        grid: {
            borderColor: isDark ? '#64748b' : '#d1d5db',
            strokeDashArray: 3,
            opacity: isDark ? 0.4 : 0.6
        }
    };
   
    const chart = new ApexCharts(document.getElementById('accuracyChart'), options);
    chart.render();
}
function drawConfusionMatrices() {
    const container = document.getElementById('confusionMatricesContainer');
    container.innerHTML = '';
   
    const modelCount = Object.keys(modelData).length;
    const gridClass = modelCount === 1 ? 'grid-cols-1' : modelCount === 2 ? 'lg:grid-cols-2' : 'lg:grid-cols-3';
    container.className = `grid ${gridClass} gap-6`;
   
    Object.keys(modelData).forEach(key => {
        const data = modelData[key];
       
        const matrixDiv = document.createElement('div');
        matrixDiv.className = 'bg-gray-50 dark:bg-gradient-to-br dark:from-slate-700 dark:to-slate-800 rounded-lg p-4 border border-gray-200 dark:border-slate-500';
        matrixDiv.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <h4 class="text-md font-semibold text-gray-900 dark:text-slate-100">${data.model_info.architecture || data.model_info.name}</h4>
                <div class="w-4 h-4 rounded-full" style="background-color: ${modelColorMap[key] || modelColors[0]}"></div>
            </div>
            <div id="confusionMatrix_${key}" class="h-96"></div>
            <div class="mt-3 text-xs text-gray-600 dark:text-slate-300">
                <div class="flex justify-between">
                    <span>Total Muestras: ${data.performance_metrics.total_predictions || 'N/A'}</span>
                    <span>Accuracy: ${data.performance_metrics.overall_accuracy.toFixed(1)}%</span>
                </div>
            </div>
        `;
        container.appendChild(matrixDiv);
       
        setTimeout(() => {
            console.log(`${key}: Verificando confusion_matrix:`, data.confusion_matrix);
            if (data.confusion_matrix && data.confusion_matrix.matrix) {
                console.log(`${key}: Usando createEnhancedConfusionMatrix`);
                createEnhancedConfusionMatrix(data, `confusionMatrix_${key}`);
            } else {
                console.log(`${key}: Usando createSimulatedConfusionMatrix (fallback)`);
                createSimulatedConfusionMatrix(data, `confusionMatrix_${key}`);
            }
        }, 100);
    });
}
function drawF1ScoreChart() {
    const series = [];
    const categories = classNames;
   
    Object.keys(modelData).forEach(key => {
        const data = modelData[key];
        const f1Scores = categories.map(className => {
            const classMetrics = data.performance_metrics.per_class_metrics[className];
            return classMetrics ? classMetrics.f1_score : 0;
        });
       
        series.push({
            name: data.model_info.architecture || data.model_info.name,
            data: f1Scores,
            color: modelColorMap[key] || modelColors[0]
        });
    });
   
    const isDark = document.documentElement.classList.contains('dark');
   
    const options = {
        series: series,
        chart: {
            type: 'line',
            height: 400,
            background: 'transparent',
            foreColor: isDark ? '#cbd5e1' : '#475569',
            fontFamily: 'Inter, system-ui, sans-serif',
            toolbar: {
                show: true,
                theme: isDark ? 'dark' : 'light'
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        stroke: {
            curve: 'smooth',
            width: 3
        },
        markers: {
            size: 6,
            strokeWidth: 2,
            strokeColors: isDark ? '#1e293b' : '#ffffff'
        },
        xaxis: {
            categories: categories,
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b',
                    fontSize: '11px'
                }
            }
        },
        yaxis: {
            title: {
                text: 'F1-Score',
                style: {
                    color: isDark ? '#cbd5e1' : '#475569'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b'
                }
            }
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            style: {
                fontSize: '12px',
                fontFamily: 'Inter, system-ui, sans-serif'
            },
            custom: function({series, seriesIndex, dataPointIndex, w}) {
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#1e293b' : '#ffffff';
                const textColor = isDark ? '#e2e8f0' : '#374151';
                const borderColor = isDark ? '#475569' : '#d1d5db';
               
                return `<div class="px-3 py-2 rounded-lg shadow-lg border" style="background-color: ${bgColor}; color: ${textColor}; border-color: ${borderColor}; font-family: Inter, system-ui, sans-serif;">
                    <div class="font-semibold text-sm">${w.globals.labels[dataPointIndex]}</div>
                    <div class="text-xs mt-1">F1-Score: ${series[seriesIndex][dataPointIndex].toFixed(3)}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">${w.globals.seriesNames[seriesIndex]}</div>
                </div>`;
            }
        },
        legend: {
            labels: {
                colors: isDark ? '#cbd5e1' : '#475569'
            }
        },
        grid: {
            borderColor: isDark ? '#64748b' : '#d1d5db',
            strokeDashArray: 3,
            opacity: isDark ? 0.4 : 0.6
        }
    };
   
    const chart = new ApexCharts(document.getElementById('f1ScoreChart'), options);
    chart.render();
}
function drawTrainingTimeChart() {
    const series = [{
        name: 'Tiempo (minutos)',
        data: Object.keys(modelData).map(key => {
            const data = modelData[key];
            const trainingTime = data.speed_metrics.training_time_minutes ||
                                (data.training_config.epochs_trained * 0.5);
            return {
                x: data.model_info.architecture || data.model_info.name,
                y: trainingTime,
                fillColor: modelColorMap[key] || modelColors[0]
            };
        })
    }];
   
    const isDark = document.documentElement.classList.contains('dark');
   
    const options = {
        series: series,
        chart: {
            type: 'bar',
            height: 350,
            background: 'transparent',
            foreColor: isDark ? '#cbd5e1' : '#475569',
            fontFamily: 'Inter, system-ui, sans-serif',
            toolbar: {
                show: true,
                theme: isDark ? 'dark' : 'light'
            },
            animations: {
                enabled: true,
                easing: 'easeinout',
                speed: 800
            }
        },
        plotOptions: {
            bar: {
                horizontal: true,
                distributed: true,
                borderRadius: 4
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function(val) {
                return val.toFixed(1) + ' min';
            },
            style: {
                colors: ['#fff'],
                fontSize: '12px',
                fontWeight: 'bold'
            }
        },
        xaxis: {
            title: {
                text: 'Tiempo (minutos)',
                style: {
                    color: isDark ? '#cbd5e1' : '#475569'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b'
                }
            }
        },
        yaxis: {
            labels: {
                style: {
                    colors: isDark ? '#94a3b8' : '#64748b'
                }
            }
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            style: {
                fontSize: '12px',
                fontFamily: 'Inter, system-ui, sans-serif'
            },
            y: {
                formatter: function(val) {
                    return val.toFixed(1) + ' minutos';
                }
            },
            custom: function({series, seriesIndex, dataPointIndex, w}) {
                const isDark = document.documentElement.classList.contains('dark');
                const bgColor = isDark ? '#1e293b' : '#ffffff';
                const textColor = isDark ? '#e2e8f0' : '#374151';
                const borderColor = isDark ? '#475569' : '#d1d5db';
               
                return `<div class="px-3 py-2 rounded-lg shadow-lg border" style="background-color: ${bgColor}; color: ${textColor}; border-color: ${borderColor}; font-family: Inter, system-ui, sans-serif;">
                    <div class="font-semibold text-sm">${w.globals.labels[dataPointIndex]}</div>
                    <div class="text-xs mt-1">Tiempo: ${series[seriesIndex][dataPointIndex].toFixed(1)} min</div>
                </div>`;
            }
        },
        legend: {
            show: false
        },
        grid: {
            borderColor: isDark ? '#64748b' : '#d1d5db',
            strokeDashArray: 3,
            opacity: isDark ? 0.4 : 0.6
        }
    };
   
    const chart = new ApexCharts(document.getElementById('trainingTimeChart'), options);
    chart.render();
}
function createSimulatedConfusionMatrix(data, containerId) {
    const classes = classNames;
    const seriesData = [];
   
    classes.forEach((className, i) => {
        const rowData = [];
        const classMetrics = data.performance_metrics.per_class_metrics[className];
       
        classes.forEach((predictedClass, j) => {
            let value = 0;
           
            if (classMetrics && classMetrics.total_samples > 0) {
                if (i === j) {
                    value = classMetrics.correct_predictions || 0;
                } else {
                    const errors = classMetrics.total_samples - (classMetrics.correct_predictions || 0);
                    if (errors > 0) {
                        const baseError = Math.floor(errors / (classes.length - 1));
                        const remainder = errors % (classes.length - 1);
                        value = baseError + (j < remainder ? 1 : 0);
                    }
                }
            }
            rowData.push(value);
        });
       
        seriesData.push({
            name: className,
            data: rowData
        });
    });
   
    const isDark = document.documentElement.classList.contains('dark');
   
    const options = {
        series: seriesData,
        chart: {
            type: 'heatmap',
            height: 380,
            background: 'transparent',
            foreColor: isDark ? '#f8fafc' : '#1f2937'
        },
        dataLabels: {
            enabled: true,
            style: {
                colors: [isDark ? '#ffffff' : '#1f2937'],
                fontSize: '12px',
                fontWeight: '700',
                textShadow: isDark ? '1px 1px 2px rgba(0,0,0,0.8)' : '0.5px 0.5px 1px rgba(0,0,0,0.3)'
            }
        },
        xaxis: {
            categories: classes,
            title: {
                text: 'Predicho',
                style: {
                    color: isDark ? '#f8fafc' : '#1f2937',
                    fontSize: '14px',
                    fontWeight: '600'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#f1f5f9' : '#4b5563',
                    fontSize: '11px',
                    fontWeight: '500'
                }
            }
        },
        yaxis: {
            title: {
                text: 'Real',
                style: {
                    color: isDark ? '#f8fafc' : '#1f2937',
                    fontSize: '14px',
                    fontWeight: '600'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#f1f5f9' : '#4b5563',
                    fontSize: '11px',
                    fontWeight: '500'
                }
            }
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light'
        },
        plotOptions: {
            heatmap: {
                shadeIntensity: 0.7,
                radius: 3,
                useFillColorAsStroke: false,
                colorScale: {
                    ranges: [
                        { from: 0, to: 0, color: isDark ? '#1e293b' : '#e2e8f0', name: 'Cero' },
                        { from: 1, to: 3, color: isDark ? '#dc2626' : '#fca5a5', name: 'Muy Bajo' },
                        { from: 4, to: 7, color: isDark ? '#ea580c' : '#fdba74', name: 'Bajo' },
                        { from: 8, to: 15, color: isDark ? '#f59e0b' : '#fcd34d', name: 'Medio' },
                        { from: 16, to: 25, color: isDark ? '#16a34a' : '#86efac', name: 'Alto' },
                        { from: 26, to: 100, color: isDark ? '#2563eb' : '#93c5fd', name: 'Muy Alto' }
                    ]
                }
            }
        }
    };
   
    const chart = new ApexCharts(document.getElementById(containerId), options);
    chart.render();
}
function createEnhancedConfusionMatrix(data, containerId) {
    const matrix = data.confusion_matrix.matrix;
    const classes = data.confusion_matrix.classes || classNames;
   
    console.log(`createEnhancedConfusionMatrix: matriz recibida`, matrix);
    console.log(`createEnhancedConfusionMatrix: clases`, classes);
   
    const seriesData = [];
    matrix.forEach((row, i) => {
        seriesData.push({
            name: classes[i],
            data: row
        });
    });
   
    const isDark = document.documentElement.classList.contains('dark');
    const maxValue = Math.max(...matrix.flat());
   
    console.log(`createEnhancedConfusionMatrix: maxValue=${maxValue}`);
    const options = {
        series: seriesData,
        chart: {
            type: 'heatmap',
            height: 380,
            background: 'transparent',
            foreColor: isDark ? '#f8fafc' : '#1f2937'
        },
        dataLabels: {
            enabled: true,
            style: {
                colors: [isDark ? '#ffffff' : '#1f2937'],
                fontSize: '12px',
                fontWeight: '700',
                textShadow: isDark ? '1px 1px 2px rgba(0,0,0,0.8)' : '0.5px 0.5px 1px rgba(0,0,0,0.3)'
            }
        },
        xaxis: {
            categories: classes,
            title: {
                text: 'Predicho',
                style: {
                    color: isDark ? '#f8fafc' : '#1f2937',
                    fontSize: '14px',
                    fontWeight: '600'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#f1f5f9' : '#4b5563',
                    fontSize: '11px',
                    fontWeight: '500'
                }
            }
        },
        yaxis: {
            title: {
                text: 'Real',
                style: {
                    color: isDark ? '#f8fafc' : '#1f2937',
                    fontSize: '14px',
                    fontWeight: '600'
                }
            },
            labels: {
                style: {
                    colors: isDark ? '#f1f5f9' : '#4b5563',
                    fontSize: '11px',
                    fontWeight: '500'
                }
            }
        },
        tooltip: {
            theme: isDark ? 'dark' : 'light',
            y: {
                formatter: function(value, { seriesIndex, dataPointIndex, w }) {
                    const realClass = classes[seriesIndex];
                    const predictedClass = classes[dataPointIndex];
                    return `Real: ${realClass}<br>Predicho: ${predictedClass}<br>Cantidad: ${value}`;
                }
            }
        },
        plotOptions: {
            heatmap: {
                shadeIntensity: 0.8,
                radius: 3,
                useFillColorAsStroke: false,
                colorScale: {
                    ranges: [
                        { from: 0, to: Math.ceil(maxValue * 0.1), color: isDark ? '#1e293b' : '#e2e8f0', name: 'Muy Bajo' },
                        { from: Math.ceil(maxValue * 0.1) + 1, to: Math.ceil(maxValue * 0.3), color: isDark ? '#dc2626' : '#fca5a5', name: 'Bajo' },
                        { from: Math.ceil(maxValue * 0.3) + 1, to: Math.ceil(maxValue * 0.5), color: isDark ? '#ea580c' : '#fdba74', name: 'Medio' },
                        { from: Math.ceil(maxValue * 0.5) + 1, to: Math.ceil(maxValue * 0.8), color: isDark ? '#16a34a' : '#86efac', name: 'Alto' },
                        { from: Math.ceil(maxValue * 0.8) + 1, to: maxValue, color: isDark ? '#2563eb' : '#93c5fd', name: 'Muy Alto' }
                    ]
                }
            }
        }
    };
   
    const chart = new ApexCharts(document.getElementById(containerId), options);
    chart.render();
}
function waitForApexCharts() {
    if (typeof ApexCharts !== 'undefined') {
        loadModelData();
    } else {
        setTimeout(waitForApexCharts, 100);
    }
}
document.addEventListener('DOMContentLoaded', waitForApexCharts);
</script>
{% endblock %}